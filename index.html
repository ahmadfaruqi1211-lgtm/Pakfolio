<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PakFolio - Pakistan Stock Tax Calculator</title>
    <meta name="description" content="Calculate your exact PSX capital gains tax before you sell. FBR-compliant FIFO method for Pakistan stocks.">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10B981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PakFolio">
    <meta name="application-name" content="PakFolio">
    <meta name="msapplication-TileColor" content="#0f172a">
    <meta name="msapplication-config" content="/browserconfig.xml">

    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.svg">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#10B981">

    <!-- Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <link rel="stylesheet" href="css/styles.css">

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header - Compact -->
        <header class="header-compact">
            <div class="header-left">
                <div class="logo-box">
                    <span class="logo-text">PakFolio</span>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" onclick="app.switchTab('more')" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Tab (Bento Dashboard) -->
            <div id="tab-home" class="tab-content active">
                <div class="bento-grid-container">
                    
                    <!-- 1. Tax Summary Cell (Main Hero) -->
                    <div class="bento-cell area-summary" id="taxSummaryHero">
                        <div class="glass-highlight"></div>
                        <div class="hero-header">
                            <h2 class="hero-label">Total Estimated Tax</h2>
                            <div class="tax-rate-pill" id="taxRateBadge">
                                <span id="taxRateValue">15%</span>
                                <span id="taxRateStatus" class="opacity-75">Filer</span>
                            </div>
                        </div>
                        
                        <div class="hero-main-value">
                            <span class="currency">Rs.</span>
                            <span class="value" id="heroTaxLiability">0.00</span>
                        </div>
                        
                        <div class="hero-context-clean">
                            on realized gains of <span class="highlight-text" id="heroContextGains">Rs. 0.00</span>
                        </div>
                        
                        <!-- Compact Metrics inside Summary -->
                        <div class="mini-metrics-row">
                            <div class="mini-metric">
                                <span class="label">Net Gain</span>
                                <span class="value gain-text" id="heroNetGain">0</span>
                            </div>
                            <div class="mini-metric">
                                <span class="label">Cost Basis</span>
                                <span class="value" id="heroCostBasis">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Actions Cell -->
                    <div class="bento-cell area-actions flex-center-col" onclick="app.switchTab('add')" style="cursor: pointer; background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2);">
                        <div class="action-icon-circle">
                            <i data-lucide="plus" style="width: 32px; height: 32px; color: #10B981;"></i>
                        </div>
                        <h3>Add Transaction</h3>
                        <p class="text-sm opacity-70">Record a buy or sell</p>
                    </div>

                    <!-- 3. Welcome/Onboarding Cell (Dynamic) -->
                    <div id="welcomeEmptyState" class="bento-cell area-marketing" style="display: none;">
                        <div class="onboarding-content">
                            <div class="icon-box-glow">
                                <i data-lucide="sparkles" class="text-primary"></i>
                            </div>
                            <h3>Welcome to PakFolio</h3>
                            <p>Your smart tax companion for PSX.</p>
                            <div class="steps-list-compact">
                                <div class="step-item">
                                    <span class="step-num">1</span> Add Purchases
                                </div>
                                <div class="step-item">
                                    <span class="step-num">2</span> Track Gains
                                </div>
                                <div class="step-item">
                                    <span class="step-num">3</span> Auto-Calculate Tax
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- 4. Quick Stats / Holdings Preview -->
                     <div class="bento-cell area-settings">
                        <div class="cell-header">
                            <h3>Analytics</h3>
                        </div>
                        <div class="stats-list">
                            <div class="stat-row">
                                <span>Proceeds</span>
                                <span id="heroSaleProceeds" class="font-mono">Rs. 0</span>
                            </div>
                            <div class="stat-row">
                                <span>Tax Rate</span>
                                <span class="font-mono">15%</span>
                            </div>
                             <div class="stat-row">
                                <span>Status</span>
                                <span class="status-active">Active</span>
                            </div>
                        </div>
                     </div>

                </div>
            </div>

            <!-- Add Transaction Tab -->
            <div id="tab-add" class="tab-content">
                <!-- Quick Transaction Entry -->
                <section class="glass-card animate-fade-in-up">
                    <div class="card-header-modern">
                        <div class="card-icon primary">
                            <i data-lucide="plus-circle" class="lucide-lg"></i>
                        </div>
                        <div>
                            <h3 class="card-title-modern">Add Transaction</h3>
                            <p class="card-subtitle">Quick entry - all fields on one screen</p>
                        </div>
                    </div>

                    <form id="transactionForm" class="form-modern">
                        <!-- Transaction Type Toggle -->
                        <div class="transaction-type-toggle">
                            <button type="button" class="type-btn active" data-type="BUY" onclick="selectTransactionType('BUY')">
                                <i data-lucide="trending-up" class="lucide-sm"></i>
                                Buy
                            </button>
                            <button type="button" class="type-btn" data-type="SELL" onclick="selectTransactionType('SELL')">
                                <i data-lucide="trending-down" class="lucide-sm"></i>
                                Sell
                            </button>
                            <input type="hidden" id="transactionType" value="BUY" required>
                        </div>

                        <!-- Form Fields -->
                        <div class="form-grid">
                            <div class="input-float">
                                <input type="text" id="symbol" placeholder=" " required autocomplete="off">
                                <label for="symbol">Stock Symbol</label>
                                <span class="input-hint">e.g., OGDC, HBL</span>
                            </div>
                            <div class="input-float">
                                <input type="number" id="quantity" placeholder=" " min="1" required>
                                <label for="quantity">Quantity</label>
                                <span class="input-hint">Number of shares</span>
                            </div>
                            <div class="input-float">
                                <input type="number" id="price" placeholder=" " min="0" step="0.01" required>
                                <label for="price">Price per Share</label>
                                <span class="input-hint">PKR</span>
                            </div>
                            <div class="input-float">
                                <input type="date" id="tradeDate" placeholder=" " required>
                                <label for="tradeDate">Trade Date</label>
                            </div>
                        </div>

                        <!-- Quick Summary -->
                        <div class="transaction-summary-modern" id="transactionSummary" style="display: none;">
                            <div class="summary-row">
                                <span class="summary-label-modern">Transaction Value</span>
                                <span class="summary-amount-modern" id="summaryAmount">Rs. 0.00</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-modern btn-submit">
                            <i data-lucide="plus" class="lucide-sm"></i>
                            Add Transaction
                        </button>
                    </form>
                </section>
            </div>

            <!-- Holdings Tab -->
            <div id="tab-holdings" class="tab-content">
                <!-- Holdings Display -->
                <section class="glass-card animate-fade-in-up">
                    <div class="card-header-modern" style="margin-bottom: 24px;">
                        <div class="card-icon">
                            <i data-lucide="briefcase" class="lucide-lg"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 class="card-title-modern">Current Holdings</h3>
                            <p class="card-subtitle">Your portfolio at a glance</p>
                        </div>
                        <button class="btn-modern btn-modern-secondary" onclick="app.refreshHoldings()" style="padding: 10px 16px; font-size: 0.85rem;">
                            <i data-lucide="refresh-cw" class="lucide-sm"></i> Refresh
                        </button>
                    </div>
                    <div id="holdingsDisplay" class="holdings-display">
                        <p class="empty-state">No holdings yet. Add buy transactions to get started.</p>
                    </div>
                </section>
            </div>

            <!-- Tax Report Tab -->
            <div id="tab-tax" class="tab-content">
                <!-- Tax Summary Stats -->
                <div class="tax-stats-grid" id="taxStatsGrid" style="display: none;">
                    <div class="tax-stat-card">
                        <div class="tax-stat-icon">
                            <i data-lucide="receipt"></i>
                        </div>
                        <div class="tax-stat-content">
                            <span class="tax-stat-label">Total Sales</span>
                            <span class="tax-stat-value" id="taxStatSales">0</span>
                        </div>
                    </div>
                    <div class="tax-stat-card">
                        <div class="tax-stat-icon gain">
                            <i data-lucide="trending-up"></i>
                        </div>
                        <div class="tax-stat-content">
                            <span class="tax-stat-label">Total Gain</span>
                            <span class="tax-stat-value gain" id="taxStatGain">Rs. 0</span>
                        </div>
                    </div>
                    <div class="tax-stat-card highlight">
                        <div class="tax-stat-icon tax">
                            <i data-lucide="landmark"></i>
                        </div>
                        <div class="tax-stat-content">
                            <span class="tax-stat-label">Tax Payable</span>
                            <span class="tax-stat-value tax" id="taxStatTax">Rs. 0</span>
                        </div>
                    </div>
                </div>

                <!-- Realized Gains -->
                <section class="glass-card animate-fade-in-up">
                    <div class="card-header-modern" style="margin-bottom: 20px;">
                        <div class="card-icon warning">
                            <i data-lucide="scroll-text" class="lucide-lg"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 class="card-title-modern">Transaction History</h3>
                            <p class="card-subtitle">FBR-Compliant FIFO Calculation</p>
                        </div>
                    </div>
                    <div id="realizedGainsDisplay" class="realized-gains-display">
                        <p class="empty-state">No sales recorded yet.</p>
                    </div>
                    <!-- Export Actions -->
                    <div class="tax-export-actions" id="taxExportActions" style="display: none;">
                        <button class="btn-modern" onclick="app.exportToPDF()" style="font-size: 0.85rem; padding: 12px 18px;">
                            <i data-lucide="file-down" class="lucide-sm"></i> Export PDF
                        </button>
                        <button class="btn-modern btn-modern-secondary" onclick="app.exportToJSON()" style="font-size: 0.85rem; padding: 12px 18px;">
                            <i data-lucide="download" class="lucide-sm"></i> Export JSON
                        </button>
                    </div>
                </section>
            </div>

            <!-- More Tab -->
            <div id="tab-more" class="tab-content">
                <!-- Settings -->
                <section class="glass-card animate-fade-in-up">
                    <div class="card-header-modern">
                        <div class="card-icon">
                            <i data-lucide="settings" class="lucide-lg"></i>
                        </div>
                        <h3 class="card-title-modern">Settings</h3>
                    </div>

                    <!-- Modern Toggle Setting -->
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label">
                                <i data-lucide="file-check" class="setting-icon"></i>
                                <span>Filer Status</span>
                            </div>
                            <p class="setting-desc" id="filerStatusText">You file income tax returns (15% rate)</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="filerStatus" checked>
                            <span class="toggle-track">
                                <span class="toggle-thumb"></span>
                            </span>
                        </label>
                    </div>

                    <!-- Info Box -->
                    <div class="info-box-modern" style="margin-top: 16px;">
                        <i data-lucide="info" class="info-box-icon"></i>
                        <div class="info-box-content">
                            <strong>What is Filer Status?</strong><br>
                            Filer: You file income tax returns. Currently both filers and non-filers pay 15% flat rate on securities acquired after July 1, 2024.
                        </div>
                    </div>
                </section>

                <!-- What-If Analysis / Tax Simulator -->
                <section class="glass-card glass-card-warning glow-amber animate-fade-in-up delay-1">
                    <div class="card-header-modern">
                        <div class="card-icon warning">
                            <i data-lucide="calculator" class="lucide-lg"></i>
                        </div>
                        <div>
                            <h3 class="card-title-modern">Tax Simulator</h3>
                            <p class="card-subtitle">See your exact tax before selling</p>
                        </div>
                    </div>

                    <!-- Modern Simulator Form -->
                    <div class="simulator-form">
                        <p class="simulator-prompt">I want to sell...</p>
                        <div class="simulator-grid">
                            <div class="input-float">
                                <input type="number" id="whatifQuantity" placeholder=" " min="1">
                                <label for="whatifQuantity">Quantity</label>
                                <span class="input-hint">shares</span>
                            </div>
                            <div class="input-float">
                                <input type="text" id="whatifSymbol" placeholder=" " autocomplete="off">
                                <label for="whatifSymbol">Symbol</label>
                                <span class="input-hint">e.g., OGDC</span>
                            </div>
                            <div class="input-float">
                                <input type="number" id="whatifPrice" placeholder=" " min="0" step="0.01">
                                <label for="whatifPrice">Price</label>
                                <span class="input-hint">PKR per share</span>
                            </div>
                            <div class="input-float">
                                <input type="date" id="whatifDate" placeholder=" ">
                                <label for="whatifDate">Sale Date</label>
                            </div>
                        </div>
                        <button class="btn-modern btn-warning btn-submit" onclick="app.runWhatIfAnalysis()">
                            <i data-lucide="calculator" class="lucide-sm"></i>
                            Calculate My Tax
                        </button>
                    </div>

                    <!-- Comparison Results -->
                    <div id="whatifResults" class="whatif-results"></div>
                </section>

            <!-- Corporate Actions -->
            <section class="glass-card animate-fade-in-up delay-2">
                <div class="card-header-modern">
                    <div class="card-icon primary">
                        <i data-lucide="git-branch" class="lucide-lg"></i>
                    </div>
                    <h3 class="card-title-modern">Corporate Actions</h3>
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 1rem; line-height: 1.5;">
                    When companies announce <strong>bonus shares</strong> or <strong>right issues</strong>, use this tool to automatically adjust your holdings and cost basis.
                </p>

                <!-- Educational Info Boxes -->
                <div class="info-cards-grid">
                    <!-- Bonus Shares Explanation -->
                    <div class="info-card info-card-success">
                        <div class="info-card-icon">
                            <i data-lucide="gift" style="width: 24px; height: 24px; color: var(--success-green);"></i>
                        </div>
                        <div class="info-card-content">
                            <h4 class="info-card-title">Bonus Shares</h4>
                            <p class="info-card-text">Company gives you <strong>free additional shares</strong> based on how many you own.</p>
                            <div class="info-card-example">
                                <strong>Example:</strong> You own 100 shares. Company announces 20% bonus.<br>
                                → You receive 20 free shares (total: 120)
                            </div>
                        </div>
                    </div>

                    <!-- Right Issue Explanation -->
                    <div class="info-card info-card-blue">
                        <div class="info-card-icon">
                            <i data-lucide="coins" style="width: 24px; height: 24px; color: #3b82f6;"></i>
                        </div>
                        <div class="info-card-content">
                            <h4 class="info-card-title" style="color: #3b82f6;">Right Issue</h4>
                            <p class="info-card-text">Company offers you <strong>additional shares at a discount</strong> (you must pay).</p>
                            <div class="info-card-example">
                                <strong>Example:</strong> You own 100 shares. Company offers 1:5 right @ Rs. 80.<br>
                                → Buy 20 more at Rs. 80 each
                            </div>
                        </div>
                    </div>
                </div>

                <form id="corporateActionForm" class="ca-form-modern" onsubmit="event.preventDefault(); handleCorporateActionSubmit();">
                    <div class="ca-form-grid">
                        <div class="input-float">
                            <select id="caType" required onchange="toggleRightIssueFields()">
                                <option value="BONUS">Bonus Shares (Free)</option>
                                <option value="RIGHT">Right Issue (Buy at discount)</option>
                            </select>
                            <label for="caType">Action Type</label>
                        </div>
                        <div class="input-float">
                            <input type="text" id="caSymbol" placeholder=" " required autocomplete="off">
                            <label for="caSymbol">Stock Symbol</label>
                            <span class="input-hint">e.g., HBL</span>
                        </div>
                        <div class="input-float">
                            <input type="text" id="caRatio" placeholder=" " required>
                            <label for="caRatio">Ratio/Percentage</label>
                            <span class="input-hint">20% or 1:5</span>
                        </div>
                        <div class="input-float" id="caPriceGroup" style="display: none;">
                            <input type="number" id="caPrice" placeholder=" " step="0.01" min="0">
                            <label for="caPrice">Right Price</label>
                            <span class="input-hint">PKR per share</span>
                        </div>
                        <div class="input-float">
                            <input type="date" id="caExDate" placeholder=" " required>
                            <label for="caExDate">Ex-Date</label>
                        </div>
                    </div>

                    <!-- Ex-Date Help Box -->
                    <div class="info-box-modern">
                        <i data-lucide="info" class="info-box-icon"></i>
                        <div class="info-box-content">
                            <strong>What is Ex-Date?</strong><br>
                            The date you must own shares by to receive this benefit. If you buy shares <strong>after</strong> the ex-date, you won't get the bonus/rights.
                        </div>
                    </div>

                    <button type="submit" class="btn-modern btn-submit">
                        <i data-lucide="check-circle" class="lucide-sm"></i>
                        Apply Corporate Action
                    </button>
                </form>
                <div id="corporateActionsHistory"></div>
            </section>

            <!-- Data Management -->
                <section class="glass-card animate-fade-in-up delay-3">
                    <div class="card-header-modern">
                        <div class="card-icon">
                            <i data-lucide="database" class="lucide-lg"></i>
                        </div>
                        <h3 class="card-title-modern">Backup & Data Management</h3>
                    </div>

                    <!-- Data Statistics -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.03) 100%); border: 1px solid rgba(16, 185, 129, 0.2); padding: 20px; border-radius: 16px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                            <i data-lucide="pie-chart" style="color: var(--success-green); width: 20px; height: 20px;"></i>
                            <h4 style="margin: 0; color: var(--success-green); font-size: 1rem; font-weight: 600;">Your Portfolio Data</h4>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Transactions</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #01652f;" id="dataStatTransactions">0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Active Holdings</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #01652f;" id="dataStatHoldings">0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Realized Sales</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #01652f;" id="dataStatSales">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Actions -->
                    <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); padding: 20px; border-radius: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 16px;">
                            <i data-lucide="hard-drive-download" style="color: #3b82f6; width: 24px; height: 24px; flex-shrink: 0;"></i>
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: #3b82f6; font-size: 1rem;">Backup Your Data</h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem; line-height: 1.5;">
                                    Export your portfolio to keep a backup. Use this before clearing data or switching devices.
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn-modern" onclick="app.exportToJSON()" style="font-size: 0.85rem; padding: 12px 18px;">
                                <i data-lucide="download" class="lucide-sm"></i> Download JSON
                            </button>
                            <button class="btn-modern btn-modern-secondary" onclick="app.exportToPDF()" style="font-size: 0.85rem; padding: 12px 18px;">
                                <i data-lucide="file-text" class="lucide-sm"></i> Download PDF
                            </button>
                        </div>
                    </div>

                    <!-- Import Actions -->
                    <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); padding: 20px; border-radius: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 16px;">
                            <i data-lucide="hard-drive-upload" style="color: #10b981; width: 24px; height: 24px; flex-shrink: 0;"></i>
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: #10b981; font-size: 1rem;">Import Data</h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem; line-height: 1.5;">
                                    Restore from a previous backup or import transactions from your broker's CSV file.
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <input type="file" id="importFile" accept=".json" style="display:none" onchange="app.importFromFile(event)">
                            <button class="btn-modern btn-modern-secondary" onclick="document.getElementById('importFile').click()" style="font-size: 0.85rem; padding: 12px 18px;">
                                <i data-lucide="folder-open" class="lucide-sm"></i> Import JSON
                            </button>
                            <input type="file" id="importCSV" accept=".csv" style="display:none" onchange="app.importFromCSV(event)">
                            <button class="btn-modern btn-modern-secondary" onclick="document.getElementById('importCSV').click()" style="font-size: 0.85rem; padding: 12px 18px;">
                                <i data-lucide="table" class="lucide-sm"></i> Import CSV
                            </button>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 0.85rem; color: #475569;">
                            <strong>CSV Format:</strong> Your broker's CSV should have columns: Date, Type (BUY/SELL), Symbol, Quantity, Price
                        </div>
                    </div>

                    <!-- Storage Info -->
                    <div style="background: rgba(255, 255, 255, 0.03); padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 1px solid rgba(255, 255, 255, 0.06);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i data-lucide="hard-drive" style="color: var(--text-muted); width: 20px; height: 20px;"></i>
                            <div id="storageInfo" class="storage-info" style="flex: 1;"></div>
                        </div>
                    </div>

                    <!-- Destructive Actions -->
                    <div class="glass-card-danger" style="padding: 20px; border-radius: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 16px;">
                            <i data-lucide="alert-triangle" style="color: var(--danger-red); width: 24px; height: 24px; flex-shrink: 0;"></i>
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: var(--danger-red); font-size: 1rem;">Danger Zone</h4>
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">
                                    <strong style="color: var(--danger-red);">Warning:</strong> These actions are permanent and cannot be undone.
                                </p>
                            </div>
                        </div>
                        <button class="btn-modern" onclick="app.clearAllData()" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); font-size: 0.85rem; padding: 12px 18px;">
                            <i data-lucide="trash-2" class="lucide-sm"></i> Clear All Data
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- PWA Install Banner (Hidden by default) -->
        <div id="pwaInstallBanner" class="pwa-install-banner hide-banner">
            <div class="pwa-install-content">
                <div class="pwa-install-icon">
                    <i data-lucide="download"></i>
                </div>
                <div class="pwa-install-text">
                    <span class="pwa-install-title">Install PakFolio</span>
                    <span class="pwa-install-desc">Fast, secure access to your stocks.</span>
                </div>
            </div>
            <div class="pwa-install-actions">
                <button class="btn-modern btn-modern-sm btn-pwa-dismiss" onclick="app.dismissInstallPrompt()">Not Now</button>
                <button class="btn-modern btn-modern-sm btn-pwa-install" onclick="app.executeInstallPrompt()">Install</button>
            </div>
        </div>

        <!-- iOS Install Modal (Add to Home Screen) -->
        <div id="iosInstallModal" class="modal-overlay ios-modal">
            <div class="modal-container-modern ios-container animate-slide-up">
                <div class="ios-modal-header">
                    <img src="pwa-192x192.png" alt="PakFolio" class="ios-app-icon">
                    <div class="ios-header-text">
                        <h3>Add to Home Screen</h3>
                        <p>Install PakFolio on your iPhone</p>
                    </div>
                    <button class="ios-close-btn" onclick="app.hideIosInstallModal()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="ios-modal-steps">
                    <div class="ios-step">
                        <div class="ios-step-num">1</div>
                        <div class="ios-step-content">
                            Tap the <strong>Share</strong> button in Safari's bottom bar.
                            <div class="ios-icon-hint"><i data-lucide="share"></i> (usually at the bottom center)</div>
                        </div>
                    </div>
                    <div class="ios-step">
                        <div class="ios-step-num">2</div>
                        <div class="ios-step-content">
                            Scroll down and select <strong>Add to Home Screen</strong>.
                            <div class="ios-icon-hint"><i data-lucide="plus-square"></i></div>
                        </div>
                    </div>
                    <div class="ios-step">
                        <div class="ios-step-num">3</div>
                        <div class="ios-step-content">
                            Tap <strong>Add</strong> in the top right corner.
                        </div>
                    </div>
                </div>
                <button class="btn-modern btn-full" onclick="app.hideIosInstallModal()">Got it</button>
            </div>
        </div>

        <!-- Bottom Tab Navigation - Modern -->
        <nav class="tab-bar-modern">
            <div class="tab-bar-container">
                <div class="tab-modern active" onclick="app.switchTab('home')">
                    <i data-lucide="home" class="tab-modern-icon"></i>
                    <div class="tab-modern-label">Home</div>
                </div>
                <div class="tab-modern" onclick="app.switchTab('holdings')">
                    <i data-lucide="briefcase" class="tab-modern-icon"></i>
                    <div class="tab-modern-label">Holdings</div>
                </div>
                <!-- Center FAB Button -->
                <div class="tab-fab" onclick="app.switchTab('add')">
                    <i data-lucide="plus"></i>
                </div>
                <div class="tab-modern" onclick="app.switchTab('tax')">
                    <i data-lucide="receipt" class="tab-modern-icon"></i>
                    <div class="tab-modern-label">Tax</div>
                </div>
                <div class="tab-modern" onclick="app.switchTab('more')">
                    <i data-lucide="settings" class="tab-modern-icon"></i>
                    <div class="tab-modern-label">More</div>
                </div>
            </div>
        </nav>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Pakistan Stock Tax Calculator | FIFO Method | Pakistan CGT Rules (15% flat rate for securities acquired after July 1, 2024)</p>
            <p class="disclaimer">This tool is for informational purposes only. Consult a tax professional for official tax advice.</p>
        </footer>
    </div>

    <!-- Message Toast -->
    <div id="messageToast" class="toast-modern">
        <div class="toast-icon" id="toastIcon">
            <i data-lucide="check-circle"></i>
        </div>
        <div class="toast-content">
            <span class="toast-message" id="toastMessage"></span>
        </div>
        <button class="toast-close" onclick="app.hideToast()">
            <i data-lucide="x"></i>
        </button>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal-overlay loading-modal">
        <div class="modal-container-modern">
            <div class="loading-spinner-modern">
                <div class="spinner-ring"></div>
                <div class="spinner-icon">
                    <i data-lucide="loader-2"></i>
                </div>
            </div>
            <h2 class="loading-title" id="loadingTitle">Processing...</h2>
            <p class="loading-description" id="loadingDescription">Please wait while we calculate your tax.</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal-overlay error-modal">
        <div class="modal-container">
            <div class="modal-icon">
                <i data-lucide="alert-triangle" style="width: 48px; height: 48px; color: var(--warning-amber);"></i>
            </div>
            <h2 class="modal-title" id="errorTitle">Can't Complete Action</h2>
            <p class="modal-description" id="errorDescription">Something went wrong.</p>
            <div class="error-details" id="errorDetails" style="display: none;">
                <!-- Dynamic error details will be inserted here -->
            </div>
            <div class="modal-actions" id="errorActions">
                <button class="btn btn-primary" onclick="app.hideErrorModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay confirm-modal">
        <div class="modal-container">
            <div class="confirm-icon" id="confirmIcon">
                <i data-lucide="alert-triangle"></i>
            </div>
            <h2 class="confirm-title" id="confirmTitle">Are you sure?</h2>
            <p class="confirm-description" id="confirmDescription">This action cannot be undone.</p>
            <div class="confirm-details" id="confirmDetails" style="display: none;">
                <!-- Dynamic details will be inserted here -->
            </div>
            <div class="confirm-input-wrapper" id="confirmInputWrapper" style="display: none;">
                <label class="confirm-input-label" id="confirmInputLabel">Type "DELETE" to confirm:</label>
                <input type="text" id="confirmInput" class="confirm-input" placeholder="Type here..." autocomplete="off">
            </div>
            <div class="modal-actions" id="confirmActions">
                <button class="btn btn-secondary" onclick="app.hideConfirmModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn" onclick="app.executeConfirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Load JavaScript Modules -->
    <script src="js/fifo-engine.js?v=3.0.0"></script>
    <script src="js/tax-calculator.js?v=3.0.0"></script>
    <script src="js/storage-manager.js?v=3.0.0"></script>
    <script src="js/what-if-scenarios.js?v=3.0.0"></script>
    <script src="js/pdf-generator.js?v=3.0.0"></script>
    <script src="js/corporate-actions.js?v=3.0.0"></script>
    <script src="js/app.js?v=3.0.0"></script>

    <!-- Corporate Actions UI Helper Script -->
    <script>
        // Toggle right issue price field
        function toggleRightIssueFields() {
            const type = document.getElementById('caType').value;
            const priceGroup = document.getElementById('caPriceGroup');
            const priceInput = document.getElementById('caPrice');

            if (type === 'RIGHT') {
                priceGroup.style.display = 'block';
                priceInput.required = true;
            } else {
                priceGroup.style.display = 'none';
                priceInput.required = false;
            }
        }

        // Handle corporate action form submission
        function handleCorporateActionSubmit() {
            const type = document.getElementById('caType').value;
            const symbol = document.getElementById('caSymbol').value.toUpperCase();
            const ratio = document.getElementById('caRatio').value;
            const exDate = document.getElementById('caExDate').value;
            const price = document.getElementById('caPrice').value;

            try {
                if (type === 'BONUS') {
                    app.applyBonusShares(symbol, ratio, exDate);
                } else if (type === 'RIGHT') {
                    if (!price) {
                        app.showMessage('Right issue price is required', 'error');
                        return;
                    }
                    app.applyRightIssue(symbol, ratio, parseFloat(price), exDate);
                }

                // Reset form
                document.getElementById('corporateActionForm').reset();
            } catch (error) {
                app.showMessage(`Error: ${error.message}`, 'error');
            }
        }

        // Transaction type toggle
        function selectTransactionType(type) {
            // Update hidden input
            document.getElementById('transactionType').value = type;

            // Update button states
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // Re-render icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            toggleRightIssueFields();
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Set default date to today
            const tradeDateInput = document.getElementById('tradeDate');
            if (tradeDateInput && !tradeDateInput.value) {
                tradeDateInput.value = new Date().toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>
